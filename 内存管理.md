# 内存管理

## 内存的分配

在iOS中，数据是存放在栈和堆中，我们的内存管理通常是对堆内存进行管理，栈上的内存是由系统自动进行管理的。

基本数据内类，存储在栈上。

OC对象是存储在堆上。这里需要注意的是和Swift的区别。



## 引用计数

引用计数是计算机编程语言中的一种内存管理计数，是指将资源（可以是类的实例对象，内存或者是磁盘空间）的被引用次数保存起来，当引用计数变为零的时候将其自动释放的一个过程。



## 属性引用类型：

`stong`表示强引用，当对象没有任何一个强引用指向他的时候，他自动释放。在申明属性的时候，如果没有添加引用类型，默认为`strong`。当需要释放 强引用指向的对象时，需要保证所有指向对象的强引用都只为nil。

`weak`表示弱引用，它也借助了类似于引用计数表的散列表，它通过对象的内存地址为key，而对应的变量的地址作为value注册到weak表中。当指向的对象呗销毁时，会通过其内存地址这个key去表中进行检索，然后将其从表中删除，所以weak修饰的属性只是在weak注册记录，并没将引用加1。



## 堆和栈

### 内存管理范围

- 任何继承与NSObject的对象
- 对其他非对象类型无效

也就是所只有OC对象需要进行内存管理。非OC对象也就是基本数据类型是不需要进行内存管理的。



### 堆和栈的概念

堆： 是大家共有的空间，分全局堆和局部堆。全局堆就是所有没有分配的空间，局部堆就是用户分配的空间。堆在操作系统对进程 初始化的时候分配，运行过程中也可以向系统要额外的堆，但是记得用完了要还给操作系统，要不然就是内存泄漏。堆里面一般 放的是静态数据，比如static的数据和字符串常量等，资源加载后一般也放在堆里面。一个进程的所有线程共有这些堆 ，所以对堆的操作要考虑同步和互斥的问题。程序里面编译后的数据段都是堆的一部分。

栈： 是个线程独有的，保存其运行状态和局部自动变量的。栈在线程开始的时候初始化，每个线程的栈互相独立，因此 ，栈是　thread safe的。每个c++对象的数据成员也存在在栈中，每个函数都有自己的栈，栈被用来在函数之间传递参数。操作系统在切换线程的时候会自动的切换栈，就是 切换ss/esp寄存器。栈空间不需要在高级语言里面显式的分配 和释放。

可能看起来有点晦涩，简单解释就是，堆是由开发者自己分配的不连续的内存地址。而栈是用系统自动分配的连续的内存地址。

